\documentclass[10pt]{extarticle}
\directlua{require("lib_resources/script.lua")}

\usepackage{geometry}
\usepackage{polyglossia}
\usepackage{microtype}
\usepackage{fontspec}
\usepackage{csquotes}
\usepackage{titlesec}
\usepackage{xcolor}
\usepackage[abspage]{zref}
\usepackage{changepage}
\usepackage{ifthen}
\usepackage{graphicx}
\usepackage{lmodern}
\usepackage{eso-pic}
\usepackage{calc}
\usepackage{fancyhdr}

\pagestyle{empty}

\strictpagecheck
\setmainlanguage{czech}

\newlength{\songchordlen}
\newlength{\songchordtmp}

\newcounter{songcnt}

\newsavebox{\songbox}
\newcommand\songmeasurebox{\dimexpr\ht\songbox+\dp\songbox\relax}

\newenvironment{song}[4][]{\directlua{startrecording("#2", "#3", "#1", "#4")}}{%
	\begin{lrbox}{\songbox}\noindent\begin{minipage}{\linewidth}\directlua{stoprecording()}\end{minipage}\end{lrbox}
	\null\clearpage\null
	\checkoddpage
	\ifoddpage
		\ifthenelse{\songmeasurebox>\textheight}{\null\newpage\null}{\clearpage}%
	\fi
	\thispagestyle{songstyle}
	\leavevmode \\
	\directlua{stoprecording()}
}

\newcommand{\songchordbox}[1]{\makebox[\width][l]{\strut\raisebox{1em}{\textbf{#1}}}\kern0.2em}
\newcommand{\songpart}[1]{\llap{\textcolor{songpartcolor}{\raisebox{-0.4em}[0em][0em]{\textbf{\songpartfont \huge #1}}\kern0.4em}}}

\newcommand{\songchord}[1]{\settowidth{\songchordtmp}{\songchordbox{#1}}\addtolength{\songchordlen}{\songchordtmp}\songchordbox{#1}}
\newcommand{\songverse}[1]{\songpart{#1.}\kern-0.05em}
\newcommand{\songchorus}{\songpart{R:}}
\newcommand{\songchordkern}{\kern-\songchordlen\setlength{\songchordlen}{0em}}

\fancypagestyle{songstyle}{\fancyhf{}\renewcommand{\headrulewidth}{1pt}\renewcommand{\footrulewidth}{1pt}
	\fancyhead[C]{\rule[-2ex]{0pt}{2ex}\songnamefont\leftmark}
	\fancyfoot[RE]{\songurlfont\rightmark}
	\fancyfoot[LO]{\songurlfont\rightmark}
}

\newcommand{\songsettitleurl}[2]{\markboth{#1}{#2}}

\newcommand{\songtitlepage}{%
	\begin{titlepage}
		\centering
		\null
		\vspace{0.3cm}
		{\songtitletopfont \uppercase{\songtitletop}}

		\vfill
		\includegraphics[width=0.75\textwidth]{\songlogo}
		\vfill

		{\songtitlebottomfont \uppercase{\songtitlebottom}}
		\vspace{1.5cm}
		\null
	\end{titlepage}
	\addheaderimg
}

% Page geometry
\geometry{a5paper,twoside,top=65pt,bottom=50pt,inner=55pt,outer=55pt,headsep=20pt,footskip=20pt}
\newcommand{\addheaderimg}{
	\AddToShipoutPictureBG{%
		\put(-60,0){%
			\parbox[b][\paperheight + 20pt]{\paperwidth + 120pt}{%
				\checkoddpage
				\ifoddpage
					\raggedleft
				\fi
				\includegraphics[width=120pt]{\songlogo}
				\vfill
			}
		}
	}
}

\input{template.tex}
